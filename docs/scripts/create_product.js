// Скрипт для QuickAdd - создание нового Продукта (Exxx name) с полной структурой
module.exports = async (params) => {
    const { app, quickAddApi } = params;

    // Запрашиваем номер и название продукта в одном поле
    const productInput = await quickAddApi.inputPrompt("Номер и название продукта (например: 001 CRM Оператора):");
    if (!productInput) return;

    // Парсим ввод: первая часть — номер, остальное — название
    const parts = productInput.trim().split(' ');
    const productNumber = parts[0];
    const productName = parts.slice(1).join(' ') || 'Новый продукт';

    const fullProductName = `E${productNumber} ${productName}`;
    const productFolder = `products/${fullProductName}`;

    // Дефолтные названия для вложенных элементов
    const fbName = "FB001 Функциональный блок";
    const featureName = "F001 Функция";

    // Создаём структуру папок
    await app.vault.createFolder(productFolder);
    await app.vault.createFolder(`${productFolder}/${fbName}`);
    await app.vault.createFolder(`${productFolder}/${fbName}/${featureName}`);

    // === Содержимое index.md продукта ===
    const productIndex = `# ${fullProductName}

## Описание продукта

Краткое описание продукта и его назначения.

## Бизнес-цели

- Цель 1
- Цель 2
- Цель 3

## Целевая аудитория

| Сегмент | Описание | Потребности |
|---------|----------|-------------|
| Сегмент 1 | Описание сегмента | Основные потребности |
| Сегмент 2 | Описание сегмента | Основные потребности |

## Ключевые метрики

| Метрика | Текущее значение | Целевое значение |
|---------|------------------|------------------|
| Метрика 1 | - | Цель |
| Метрика 2 | - | Цель |

## Функциональные блоки

| Код | Название | Статус | Описание |
|-----|----------|--------|----------|
| FB001 | [Функциональный блок](./${fbName}/index.md) | Planned | Описание |

## Интеграции

- **Система 1** — описание интеграции
- **Система 2** — описание интеграции

## Roadmap

| Квартал | Функциональный блок | Описание |
|---------|---------------------|----------|
| Q1 2025 | FB001 | Описание планов |
| Q2 2025 | FB002 | Описание планов |
`;

    // === Содержимое index.md функционального блока ===
    const fbIndex = `# ${fbName}

## Описание

Краткое описание функционального блока и его назначения в продукте.

## Бизнес-цели

- Цель 1
- Цель 2

## Границы функционального блока

**Входит в scope:**

- Функциональность 1
- Функциональность 2

**Не входит в scope:**

- Другой функционал (отдельный блок)

## Функции (Features)

| Код | Название | Статус | Описание |
|-----|----------|--------|----------|
| F001 | [Функция](./${featureName}/index.md) | Planned | Описание |

## Интеграции

- **Сервис 1** — описание интеграции
- **Сервис 2** — описание интеграции

## Метрики

| Метрика | Текущее значение | Целевое значение |
|---------|------------------|------------------|
| Метрика 1 | - | Цель |
| Метрика 2 | - | Цель |
`;

    // === Содержимое файлов функции ===
    const featureIndex = `# ${featureName}

## Зачем это нужно

Краткое описание бизнес-проблемы, которую решает данная функция.

## Бизнес-эффект

Ожидаемый эффект для бизнеса:

- Метрика 1: ожидаемое изменение
- Метрика 2: ожидаемое изменение

## Пользователи и сценарии

**Основные пользователи:**

- Тип пользователя 1
- Тип пользователя 2

**Ключевые сценарии:**

1. Сценарий 1: описание
2. Сценарий 2: описание

## Функциональные требования

| ID | Описание | Приоритет |
|----|----------|-----------|
| FR-001 | Требование 1 | Must |
| FR-002 | Требование 2 | Should |
| FR-003 | Требование 3 | Could |

## Нефункциональные требования

| Категория | Требование |
|-----------|------------|
| Производительность | Время отклика < X мс |
| Доступность | SLA 99.9% |
| Безопасность | Требование безопасности |

## Ограничения и допущения

**Ограничения:**

- Техническое ограничение 1
- Бизнес-ограничение 1

**Допущения:**

- Допущение 1
- Допущение 2

## Связанные сервисы

- \`service-name-1\` — описание взаимодействия
- \`service-name-2\` — описание взаимодействия
`;

    const featureRequirements = `# Требования: ${featureName}

## Функциональные требования

| ID | Описание | Приоритет | Статус |
|----|----------|-----------|--------|
| FR-001 | Требование 1 | Must | Planned |
| FR-002 | Требование 2 | Should | Planned |
| FR-003 | Требование 3 | Could | Planned |

## Нефункциональные требования

| Категория | ID | Требование |
|-----------|-----|------------|
| Производительность | NFR-001 | Операция должна выполняться < X секунд |
| Доступность | NFR-002 | Функция доступна 99.9% времени |
| Безопасность | NFR-003 | Требование безопасности |
| Аудит | NFR-004 | Все операции логируются |

## Бизнес-правила

| ID | Правило |
|----|---------|
| BR-001 | Бизнес-правило 1 |
| BR-002 | Бизнес-правило 2 |
| BR-003 | Бизнес-правило 3 |

## Acceptance Criteria

### AC-001: Название сценария

**Given:** Предусловие (начальное состояние системы)
**When:** Действие пользователя
**Then:**

- Ожидаемый результат 1
- Ожидаемый результат 2
`;

    const featureProcess = `# Процесс: ${featureName}

## Диаграмма процесса

\`\`\`mermaid
flowchart TD
    A[Начало] --> B{Условие?}
    B -->|Да| C[Действие 1]
    B -->|Нет| D[Действие 2]
    C --> E[Конец]
    D --> E
\`\`\`

## Шаги процесса

1. **Шаг 1** — описание
2. **Шаг 2** — описание
3. **Шаг 3** — описание

## Участники

| Роль | Ответственность |
|------|-----------------|
| Пользователь | Инициирует процесс |
| Система | Обрабатывает запрос |

## Исключения

| Ситуация | Действие |
|----------|----------|
| Ошибка валидации | Показать сообщение об ошибке |
| Таймаут | Повторить запрос |
`;

    // Создаём все файлы
    await app.vault.create(`${productFolder}/index.md`, productIndex);
    await app.vault.create(`${productFolder}/${fbName}/index.md`, fbIndex);
    await app.vault.create(`${productFolder}/${fbName}/${featureName}/index.md`, featureIndex);
    await app.vault.create(`${productFolder}/${fbName}/${featureName}/requirements.md`, featureRequirements);
    await app.vault.create(`${productFolder}/${fbName}/${featureName}/process.md`, featureProcess);

    // Открываем index.md продукта
    const file = app.vault.getAbstractFileByPath(`${productFolder}/index.md`);
    await app.workspace.getLeaf().openFile(file);

    new Notice(`Продукт "${fullProductName}" создан с полной структурой!`);
};
